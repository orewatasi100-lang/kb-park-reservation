<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <!-- ã‚¹ãƒãƒ›å…¨é¢æœ€é©åŒ–ï¼ˆå…¨å¹…ï¼‰ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>ãƒ›ãƒƒãƒ”ãƒ³ãƒãƒƒã‚·ãƒ¥ç¦å±±åº— äºˆç´„</title>
  <?!= include('styles'); ?>
</head>
<body>
  <!-- èƒŒæ™¯ãƒ­ã‚´ -->
  <div class="bg-logo"></div>

  <!-- å…¥åŠ›æœªå®Œäº†ã®å¤§ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  <div id="nudge" class="nudge">æœªå…¥åŠ›ã®æ¬„ãŒã‚ã‚Šã¾ã™</div>

  <!-- é€ä¿¡ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="overlay" class="overlay" style="display:none">
    <div class="overlay-card"><div id="overlayText">é€ä¿¡ä¸­â€¦</div></div>
  </div>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="reviewModal" class="modal" style="display:none" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-hd">
        <strong>äºˆç´„å†…å®¹ã®ç¢ºèª</strong>
        <button class="modal-close" onclick="closeReviewModal()" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="modal-body">
        <p><b>æ—¥æ™‚</b>ï¼š<span id="rvDateTime">-</span></p>
        <p><b>äººæ•°</b>ï¼š<span id="rvPeople">-</span></p>
        <p><b>æ°å</b>ï¼š<span id="rvName">-</span></p>
        <p><b>ãƒ¡ãƒ¼ãƒ«</b>ï¼š<span id="rvEmail">-</span></p>
        <p><b>é›»è©±</b>ï¼š<span id="rvPhone">-</span></p>
        <p><b>ä½æ‰€</b>ï¼š<span id="rvAddr">-</span></p>
        <p><b>åˆè¨ˆé‡‘é¡</b>ï¼š<span id="rvAmount">-</span></p>
        <hr/>

        <!-- ã“ã“ã‹ã‚‰ï¼šãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="otpSection" class="otp-section">
          <p id="otpInfo" class="muted">
            ã‚³ãƒ¼ãƒ‰é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ãŸã ã<br>
            ãƒ¡ãƒ¼ãƒ«ã«æ›¸ã„ã¦ã‚ã‚‹4æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
          </p>
          <div class="otp-center">
            <button id="otpSendBtn" class="btn-outline small" type="button" aria-live="polite">ã‚³ãƒ¼ãƒ‰é€ä¿¡</button>
            <input id="otpInput" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="4æ¡ã‚³ãƒ¼ãƒ‰" />
          </div>
          <div class="otp-center" style="margin-top:12px">
            <button id="otpVerifyBtn" class="btn small" type="button" aria-live="polite">ç¢ºèª</button>
          </div>
          <div id="otpCountdown" class="muted" style="display:none; margin-top:6px"></div>
        </div>

        <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šç·š -->
        <hr class="section-divider" />

        <div class="terms" style="margin-top:12px">
          <ul class="small-note">
            <li>äºˆç´„å½“æ—¥ï¼ˆ0ï¼š00ä»¥é™ï¼‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯å…¨é¡ã”è² æ‹…ã„ãŸã ãã¾ã™ã€‚</li>
            <li>äºˆç´„ã‚’ç¢ºå®šã™ã‚‹ã¨ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã¾ã™ã€‚</li>
            <li>å±Šã‹ãªã„å ´åˆã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã”ç¢ºèªã®ä¸Šã€ã‚‚ã†ä¸€åº¦äºˆç´„ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</li>
          </ul>
        </div>

        <label class="agree" style="margin-top:8px">
          <input id="reviewAgree" type="checkbox" onchange="onAgreeChanged()">
          <span class="agree-label">äºˆç´„å†…å®¹ã«é–“é•ãˆãŒç„¡ã„ã“ã¨ã‚’ç¢ºèªã—è¦ç´„ã«åŒæ„ã—ã¾ã™</span>
        </label>
        <!-- ğŸ‘‡ ã“ã®è¡Œã¯å‰Šé™¤ -->
        <!-- <div class="muted" style="margin-top:4px">åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¾ã—ãŸ</div> -->
      </div>
      <div class="modal-ft">
        <button id="reviewConfirmBtn" class="btn" disabled onclick="finalSubmit()">äºˆç´„ã‚’ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- OTPæˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="otpOkModal" class="modal" style="display:none" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-hd">
        <strong>èªè¨¼ã§ãã¾ã—ãŸ</strong>
        <button class="modal-close" onclick="closeOtpOkModal()" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="modal-body">
        <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
      </div>
      <div class="modal-ft">
        <button class="btn" type="button" onclick="closeOtpOkModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- â–¼â–¼ è¿½åŠ ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æœ€çµ‚ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« â–¼â–¼ -->
  <div id="cancelConfirmModal" class="modal" style="display:none" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-hd">
        <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®æœ€çµ‚ç¢ºèª</strong>
        <button class="modal-close" id="cancelConfirmNo" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="modal-body">
        <p>å½“æ—¥ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®å ´åˆã¯å…¨é¡è² æ‹…ã¨ãªã‚Šã¾ã™</p>
        <p>æœ¬å½“ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ</p>
      </div>
      <div class="modal-ft">
        <button class="btn-outline" id="cancelConfirmNoBtn" type="button">ã„ã„ãˆ</button>
        <button class="btn" id="cancelConfirmYes" type="button">ã¯ã„</button>
      </div>
    </div>
  </div>
  <!-- â–²â–² è¿½åŠ ã“ã“ã¾ã§ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æœ€çµ‚ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« â–²â–² -->

  <!-- â–¼â–¼ è¿½åŠ ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«çµæœãƒ¢ãƒ¼ãƒ€ãƒ« â–¼â–¼ -->
  <div id="cancelResultModal" class="modal" style="display:none" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-hd">
        <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµæœ</strong>
        <button class="modal-close" id="cancelResultClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="modal-body" id="cancelResultBody">
        <!-- JSã§æ–‡é¢ã‚’å·®ã—æ›¿ãˆã¾ã™ -->
      </div>
      <div class="modal-ft">
        <button class="btn" id="cancelResultCloseBtn" type="button">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  <!-- â–²â–² è¿½åŠ ã“ã“ã¾ã§ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«çµæœãƒ¢ãƒ¼ãƒ€ãƒ« â–²â–² -->

  <!-- æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="infoModal" class="modal" style="display:none" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-hd">
        <strong class="info-title">ã”æ¡ˆå†…</strong>
        <button class="modal-close" onclick="closeInfoModal()" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="info-body"></div>
      <div class="modal-ft"><button class="btn" onclick="closeInfoModal()">é–‰ã˜ã‚‹</button></div>
    </div>
  </div>

  <!-- åˆ©ç”¨è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒšãƒ¼ã‚¸å†… / terms.html ã‚’èª­ã¿è¾¼ã¿ï¼‰ -->
  <div id="termsModal" class="modal" style="display:none" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-hd">
        <strong>åˆ©ç”¨è¦ç´„</strong>
        <button class="modal-close" onclick="closeTerms()" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="modal-body terms-scroll">
        <?!= include('terms'); ?>
      </div>
      <div class="modal-ft">
        <button class="btn-outline" onclick="closeTerms()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- æˆåŠŸæ¼”å‡ºï¼ˆğŸ„ã‚¨ãƒ¢ã‚¸ï¼‹ç´™å¹é›ªï¼‰â€»æ—¢å­˜ -->
  <div id="success" class="success">
    <div class="success-inner">
      <div class="confetti" aria-hidden="true"></div>
      <span class="mush-emoji bounce" role="img" aria-label="ãã®ã“"><img src="https://msp.c.yimg.jp/images/v2/FUTi93tXq405grZVGgDqG40yntl66Vd8f8A8GdNaSPNHWO-P2_c_V2IK2-hpt0qa8NpDbcpdjVjW6sjFkzU7M44H_dlad3LgBfrYR5Htin-iBe9LmvH8TtY4tuCC-Tcu-rYwQSUXycB-p2iBsqZdBaWHMlXRAs-jtx4HHo5npKOdjTPwF4fhcWRP5oZJEgTIgPvDecurUbz5xLxCrHZJ2qqeJlCcdB45iKaojAflNv1TAr0dFMmuz96UfXzfL-Guc0HQYbG-PHdtdVLPTzbfV0TWjuRgo6N-GzO8TV7FXADuj-bNxtbvZHSIu3oHMhpWVGrUPufDOGrRknWCXSlBfyVlQAOuydEcPFkln-G0GI2ilid3UFCd-FWgNcUGY_PDBlLJpQ5C7aPRiYU2r2WBJA==/h9xMJkD_9Itg3P4SOxwl718LCUU3avnPef2ZjSSdmEGOL4FxLAPbXizVCxq3FcASFy3-_NkBWTks900-c-k-c0x00ffffff-no-rj?errorImage=false" alt="ãã®ã“" style="width:1em;height:1em;vertical-align:middle;object-fit:contain;border-radius:0.1em"/></span>
      <div class="done">
        <div>äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</div>
        <div>ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™</div>
      </div>
    </div>
  </div>

  <!-- äºˆç´„å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="finalModal" class="final-modal" role="dialog" aria-modal="true">
    <div class="final-card" role="document">
      <div class="final-title">äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
      <div class="final-sub">æ¥åº—ãŠå¾…ã¡ã—ã¦ã¾ã™</div>
      <div class="final-mush" aria-hidden="true"><img src="https://msp.c.yimg.jp/images/v2/FUTi93tXq405grZVGgDqG40yntl66Vd8f8A8GdNaSPNHWO-P2_c_V2IK2-hpt0qa8NpDbcpdjVjW6sjFkzU7M44H_dlad3LgBfrYR5Htin-iBe9LmvH8TtY4tuCC-Tcu-rYwQSUXycB-p2iBsqZdBaWHMlXRAs-jtx4HHo5npKOdjTPwF4fhcWRP5oZJEgTIgPvDecurUbz5xLxCrHZJ2qqeJlCcdB45iKaojAflNv1TAr0dFMmuz96UfXzfL-Guc0HQYbG-PHdtdVLPTzbfV0TWjuRgo6N-GzO8TV7FXADuj-bNxtbvZHSIu3oHMhpWVGrUPufDOGrRknWCXSlBfyVlQAOuydEcPFkln-G0GI2ilid3UFCd-FWgNcUGY_PDBlLJpQ5C7aPRiYU2r2WBJA==/h9xMJkD_9Itg3P4SOxwl718LCUU3avnPef2ZjSSdmEGOL4FxLAPbXizVCxq3FcASFy3-_NkBWTks900-c-k-c0x00ffffff-no-rj?errorImage=false" alt="" aria-hidden="true" style="width:1em;height:1em;vertical-align:middle;object-fit:contain;"/></div>
      <div style="margin-top:16px">
        <button class="btn" type="button"
          onclick="window.location.href='https://hoppingmushroom.com/facility/fukuyama.html'">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <header class="hd">
    <div class="titleLogo">
      <img src="https://hoppingmushroom.com/img/header-logo-fukuyama-pc.svg" alt="ãƒ›ãƒƒãƒ”ãƒ³ãƒãƒƒã‚·ãƒ¥ç¦å±±åº—" />
      <div class="subtitle">äºˆç´„ã‚µã‚¤ãƒˆ</div>
    </div>
  </header>

  <main class="container fullbleed">
    <div id="banner" class="banner" style="display:none"></div>

    <section class="card edge">
      <h2>æ—¥ä»˜ã‚’é¸æŠ</h2>
      <div class="weekday-head">
        <div class="sun">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div class="sat">åœŸ</div>
      </div>
      <div id="calendar" class="calendar skeleton"></div>
    </section>

    <section class="card edge" id="slotSec" style="display:none">
      <h2><span id="selDate"></span> ã®æ™‚é–“ã‚’é¸æŠ</h2>
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ï¼šäºˆç´„å¯èƒ½ã®ã¿ / ã™ã¹ã¦è¡¨ç¤º -->
      <div class="slot-filters">
        <button id="fltAvail" class="chip chip-on" type="button">äºˆç´„å¯èƒ½ã®ã¿</button>
        <button id="fltAll" class="chip" type="button">ã™ã¹ã¦è¡¨ç¤º</button>
      </div>
      <div id="slots" class="slots skeleton"></div>
    </section>

    <section class="card edge" id="formSec" style="display:none">
      <h2>äºˆç´„æƒ…å ±</h2>
      <div class="grid-num">
        <label class="num">å¤§äºº<input type="number" id="adult" min="0" value="1" inputmode="numeric" /></label>
        <label class="num">å°å­¦ç”Ÿ<input type="number" id="elem" min="0" value="0" inputmode="numeric" /></label>
        <label class="num">æœªå°±å­¦<input type="number" id="kinder" min="0" value="0" inputmode="numeric" /></label>
        <label class="num">å›æ•°åˆ¸ã®ä½¿ç”¨æšæ•°<input type="number" id="coupon" min="0" value="0" inputmode="numeric" /></label>
      </div>
      <div class="grid-1col">
        <label id="rowName">æ°å<input id="name" autocomplete="name"/></label>
        <label id="rowEmail">ãƒ¡ãƒ¼ãƒ«
          <div class="rowWithBtn">
            <input id="email" type="email" inputmode="email" autocapitalize="none" autocorrect="off" spellcheck="false" autocomplete="email"/>
            <button id="expEmailBtn" type="button" class="iconBtn" aria-label="ãƒ¡ãƒ¼ãƒ«ã®èª¬æ˜">?</button>
          </div>
          <small id="emailErr" class="err" style="display:none">æ­£ç¢ºãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
        </label>
        <label id="rowPhone">é›»è©±<input id="phone" type="tel" inputmode="numeric" pattern="[0-9]*" autocomplete="tel"/></label>
        <label id="rowZip">éƒµä¾¿ç•ªå·ï¼ˆ7æ¡ï¼‰<input id="zip" inputmode="numeric" maxlength="7" placeholder="ä¾‹ 7210942" autocomplete="postal-code"/></label>
        <label id="rowAddrB">ä½æ‰€ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰
          <div class="rowWithBtn">
            <input id="addrBase" readonly placeholder="éƒµä¾¿ç•ªå·ã§è‡ªå‹•å…¥åŠ›"/>
            <button id="expAddrBtn" type="button" class="iconBtn" aria-label="ä½æ‰€ã®èª¬æ˜">?</button>
          </div>
        </label>
        <label id="rowAddrD">ç•ªåœ°ãƒ»å»ºç‰©å<textarea id="addrDetail" rows="2" placeholder="ç•ªåœ°ãƒ»å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·ãªã©"></textarea></label>
      </div>

      <!-- ãƒãƒ‹ãƒ¼ãƒãƒƒãƒˆï¼ˆäººé–“ã¯è¦‹ãˆãªã„ï¼‰ -->
      <input id="hp" type="text" class="hp" autocomplete="off" tabindex="-1" aria-hidden="true"/>

      <div class="est" id="estimate">åˆè¨ˆé‡‘é¡ï¼šâ€” å†† / äººæ•°ï¼šâ€” å</div>

      <div class="actions spread">
        <button id="termsBtn" class="btn-outline small" type="button" onclick="openTerms()">åˆ©ç”¨è¦ç´„</button>
        <button id="confirmBtn" class="btn press" type="button">äºˆç´„å†…å®¹ã‚’ç¢ºèª</button>
      </div>
    </section>

    <section class="card edge">
      <h2>äºˆç´„ã®ç¢ºèªãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«</h2>
      <div class="actions"><button id="cancelOpen" class="btn-outline press tiny">äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã“ã¡ã‚‰</button></div>
      <div id="cancelPanel" hidden>
        <div class="grid-num">
          <label class="num-wide">äºˆç´„æ—¥ï¼ˆ8æ¡ï¼‰<input id="cidDate" inputmode="numeric" placeholder="ä¾‹ 20250919" maxlength="8"/></label>
          <label class="num">3æ¡ID<input id="cidSeq" inputmode="numeric" placeholder="ä¾‹ 001" maxlength="3"/></label>
        </div>
        <div class="grid-1col" id="cancelEmailRow">
          <label>ãƒ¡ãƒ¼ãƒ«<input id="cemail" type="email" inputmode="email" autocapitalize="none" autocorrect="off" spellcheck="false"/></label>
        </div>
        <div class="actions"><button id="cancelBtn" class="btn-outline press">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹</button></div>
        <div id="cancelResult" class="muted"></div>
      </div>
    </section>
  </main>

  <footer class="ft"><small>Â© HoppinMush Fukuyama</small></footer>

<?!= include('app.core'); ?>


<?!= include('app.ui.bundle'); ?>


<!-- Error Modal Shim: ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«åŒ–ï¼ˆè¿½è¨˜å°‚ç”¨ã€‚æ—¢å­˜UIã¯ä¸å¤‰æ›´ï¼‰ -->
<style>
  /* æ—¢å­˜ styles ã®ãƒˆãƒ¼ãƒ³ã«åˆã‚ã›ãŸè»½é‡ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä¸Šæ›¸ãæœ€å°é™ï¼‰ */
  .emodal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:9999}
  .emodal-card{width:min(560px,92vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  .emodal-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eee}
  .emodal-ttl{font-weight:700;font-size:16px}
  .emodal-bd{padding:16px;max-height:70vh;overflow:auto;font-size:15px;line-height:1.6;white-space:pre-wrap}
  .emodal-ft{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #eee}
  .emodal-btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
  .emodal-btn.primary{background:#E60012;color:#fff}
  .emodal-btn.secondary{background:#f2f2f2;color:#333}
  .emodal-close{background:transparent;border:0;font-size:18px;cursor:pointer;line-height:1}
  .emodal-input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:15px}


/* infoModal ã®æœ¬æ–‡ã¨ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒœã‚¿ãƒ³ã‚’ç´„3å€ã« */
#infoModal .info-body     { font-size: 45px !important; line-height: 1.8; }
#infoModal .modal-hd .info-title { font-size: 48px !important; }
#infoModal .modal-ft .btn,
#infoModal .modal-close   { font-size: 42px !important; }




</style>

<script>
(function(){
  // ã™ã§ã«é©ç”¨æ¸ˆã¿ãªã‚‰äºŒé‡é©ç”¨ã—ãªã„
  if (window.__ERR_MODAL_SHIM__) return;
  window.__ERR_MODAL_SHIM__ = true;

  // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ç”Ÿæˆ
  function openModal({title="ã”æ¡ˆå†…", body="", showCancel=false, showInput=false, okText="OK", cancelText="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"}){
    return new Promise(resolve=>{
      const root = document.createElement('div');
      root.className = 'emodal-backdrop';
      root.innerHTML = `
        <div class="emodal-card" role="dialog" aria-modal="true">
          <div class="emodal-hd">
            <div class="emodal-ttl">${escapeHtml(title)}</div>
            <button class="emodal-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
          </div>
          <div class="emodal-bd">
            <div class="emodal-msg">${body}</div>
            ${showInput ? `<div style="margin-top:12px"><input class="emodal-input" type="text" id="__emodal_input" /></div>` : ``}
          </div>
          <div class="emodal-ft">
            ${showCancel ? `<button class="emodal-btn secondary" data-action="cancel">${escapeHtml(cancelText)}</button>` : ``}
            <button class="emodal-btn primary" data-action="ok">${escapeHtml(okText)}</button>
          </div>
        </div>
      `;
      function cleanup(v){
        document.removeEventListener('keydown', onKey);
        root.remove();
        resolve(v);
      }
      function onKey(e){
        if(e.key === 'Escape'){ cleanup(false); }
        if(e.key === 'Enter'){ const inp = root.querySelector('#__emodal_input'); cleanup(inp ? inp.value : true); }
      }
      root.addEventListener('click', (e)=>{
        if(e.target === root) cleanup(false);
      });
      root.querySelector('.emodal-close').addEventListener('click', ()=>cleanup(false));
      root.querySelector('[data-action="ok"]').addEventListener('click', ()=>{
        const inp = root.querySelector('#__emodal_input');
        cleanup(inp ? inp.value : true);
      });
      const cancelBtn = root.querySelector('[data-action="cancel"]');
      if(cancelBtn) cancelBtn.addEventListener('click', ()=>cleanup(false));
      document.addEventListener('keydown', onKey);
      document.body.appendChild(root);
      const i = root.querySelector('#__emodal_input');
      if (i) setTimeout(()=>i.focus(), 10);
    });
  }

  function escapeHtml(s){
    return String(s==null?"":s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // æ—¢å­˜ã® infoModal ã‚’ä½¿ã†çµŒè·¯ï¼ˆã‚ã‚Œã°æ´»ç”¨ï¼‰
  function showInfoModalCompat(message){
    const infoModal = document.getElementById('infoModal');
    const infoBody  = infoModal && infoModal.querySelector('.info-body');
    const open = (el)=>{ if(!el) return false; el.style.display = 'flex'; el.setAttribute('aria-modal','true'); el.setAttribute('role','dialog'); return true; };
    const closeBtn = infoModal && infoModal.querySelector('.modal-close');
    if(infoModal && infoBody){
      infoBody.textContent = String(message||'');
      open(infoModal);
      const close = ()=>{ infoModal.style.display='none'; };
      if(closeBtn) closeBtn.addEventListener('click', close, {once:true});
      const ok = infoModal.querySelector('.modal-ft .btn');
      if(ok) ok.addEventListener('click', close, {once:true});
      return true;
    }
    return false;
  }

  // ==== ã“ã“ã‹ã‚‰ã€Œæ¨ªå–ã‚Šã€ï¼šalert/confirm/prompt ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«åŒ– ====
  const _alert  = window.alert;
  const _confirm= window.confirm;
  const _prompt = window.prompt;

  window.alert = function(message){
    // æ—¢å­˜ infoModal ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°ã‚·ãƒ 
    if (!showInfoModalCompat(message)){
      return openModal({ title: "ã”æ¡ˆå†…", body: escapeHtml(message) }).then(()=>true);
    }
  };

  window.confirm = function(message){
    // confirm ã¯ boolean è¿”å´ã€‚ã‚·ãƒ ã¯ Promise ã‚’è¿”ã™ãŒã€æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›ã®ãŸã‚ setTimeout ã§åŒæœŸé¢¨ã«å‡¦ç†
    let resultBox = {v:false};
    openModal({ title:"ç¢ºèª", body: escapeHtml(message), showCancel:true, okText:"ã¯ã„", cancelText:"ã„ã„ãˆ" })
      .then(v=>{ resultBox.v = !!v; });
    // å¯èƒ½ãªé™ã‚Šã®äº’æ›ï¼šUIã¯éåŒæœŸã ãŒã€å‘¼ã³å‡ºã—å´ãŒåŒæœŸã‚’æœŸå¾…ã—ã¦ã„ã‚‹å ´åˆã¯ã€Œã¯ã„ã€ã‚’æŠ¼ã™ã¾ã§ä½•ã‚‚é€²ã¾ãªã„UIè¨­è¨ˆãŒå¤šã„
    return resultBox.v;
  };

  window.prompt = function(message, defaultValue){
    let resultBox = {v:null};
    openModal({
      title:"å…¥åŠ›",
      body: escapeHtml(message) + (defaultValue ? `<div style="margin-top:8px;color:#666;font-size:12px">åˆæœŸå€¤: ${escapeHtml(defaultValue)}</div>` : ""),
      showCancel:true, okText:"OK", cancelText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", showInput:true
    }).then(v=>{ resultBox.v = (v===false? null : String(v)); });
    return resultBox.v;
  };

  // ==== google.script.run ã®å¤±æ•—æ™‚ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸ï¼ˆæ±ç”¨ãƒ˜ãƒ«ãƒ‘ï¼‰ ====
  // æ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼šgoogle.script.run.withSuccessHandler(...).withFailureHandler(fn).api(...)
  // å¤±æ•—ãƒãƒ³ãƒ‰ãƒ©ã® fn å†…ã§ alert ã‚’å‘¼ã‚“ã§ã„ã‚Œã°æ—¢ã«ãƒ¢ãƒ¼ãƒ€ãƒ«åŒ–ã•ã‚Œã‚‹ãŒã€
  // ä½•ã‚‚ã—ã¦ã„ãªã„å ´åˆã«å‚™ãˆã¦ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’æä¾›ï¼ˆå¿…è¦ç®‡æ‰€ã‹ã‚‰ä»»æ„ã§åˆ©ç”¨å¯èƒ½ï¼‰ã€‚
  window.showErrorModal = function(reasonOrError){
    const msg = normalizeReason(reasonOrError);
    if (!showInfoModalCompat(msg)){
      return openModal({ title:"ã‚¨ãƒ©ãƒ¼", body: escapeHtml(msg) });
    }
  };

  function normalizeReason(r){
    if (!r) return "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    if (typeof r === 'string') return r;
    if (r.message) return r.message;
    try{
      if (r.reason) return String(r.reason);
      if (r.error) return String(r.error);
      return JSON.stringify(r).slice(0,200);
    }catch(_){
      return "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  }
})();
</script>





<!-- Capacity Modal Guard v3 â€” index.html ã® </body> ç›´å‰ã«â€œè¿½è¨˜ã®ã¿â€ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚æ—¢å­˜UIã¯ä¸å¤‰æ›´ -->
<style>
  /* å…¥åŠ›æ¬„ã®å¼·èª¿ï¼ˆè¶…éæ™‚ï¼‰ */
  .cmg-warn { outline: 2px solid #E60012 !important; border-radius: 10px; }

  /* ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¢å­˜ã« #infoModal ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆåˆ©ç”¨ï¼‰ */
  .cmg-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .cmg-card{width:min(560px,92vw);background:#fff;border-radius:14px;box-shadow:0 18px 45px rgba(0,0,0,.35);overflow:hidden}
  .cmg-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eee}
  .cmg-ttl{font-weight:700;font-size:48px}
  .cmg-bd{padding:18px 16px;max-height:70vh;overflow:auto;font-size:45px;line-height:1.7;white-space:pre-wrap}
  .cmg-ft{display:flex;gap:10px;justify-content:flex-end;padding:18px 22px;border-top:1px solid #eee}
  .cmg-btn{appearance:none;border:0;border-radius:10px;padding:10px 16px;font-size:42px;cursor:pointer;background:#E60012;color:#fff}
</style>

<script>
(function(){
  // ===== ã‚ãªãŸã® index.html ã®å®Ÿä½“ã«åˆã‚ã›ãŸã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã ã‘èª¿æ•´ï¼‰ =====
  const CFG = {
    // é¸æŠæ¸ˆã¿ã®æ—¥ä»˜ï¼ˆä¾‹: <span id="selDate">2025-10-27</span>ï¼‰
    selDate:   '#selDate',
    // ã‚¹ãƒ­ãƒƒãƒˆä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãã®ä¸­ã®ã€Œé¸æŠä¸­ãƒœã‚¿ãƒ³ã€ã‹ã‚‰æ™‚åˆ»ã¨æ®‹ã‚Šäººæ•°ã‚’æ‹¾ã†ï¼‰
    slotsWrap: '#slots',

    // äººæ•°å…¥åŠ›ï¼ˆå›ºå®šIDæƒ³å®šï¼‰
    adultSel:  '#adult',
    elemSel:   '#elem',
    kinderSel: '#kinder',
    // åˆè¨ˆæ¬„ãŒåˆ¥ã«ã‚ã‚‹ãªã‚‰ï¼ˆä»»æ„ï¼‰
    totalSel:  'input[name="totalPersons"], #totalPersons',

    // é€ä¿¡ï¼ˆäºˆç´„å†…å®¹ã‚’ç¢ºèªï¼‰
    confirmBtn: '#confirmBtn',

    // ã€Œæ®‹ã‚Šâ—¯äººã€ã®ãƒ†ã‚­ã‚¹ãƒˆãŒå…¥ã‚‹ã‚µãƒ–è¦ç´ å€™è£œï¼ˆé¸æŠä¸­ãƒœã‚¿ãƒ³ or ãã®è¦ªã®ä¸­ã‚’æ¢ã—ã¾ã™ï¼‰
    // ä¾‹: <button class="slot on" data-time="17:00"><span class="remain">æ®‹ã‚Š3äºº</span></button>
    remainSelectorsInsideSlot: ['[data-remain]', '.remain', '.remaining', '.remain-label', '.slot-remaining'],

    // é¸æŠä¸­ã‚¹ãƒ­ãƒƒãƒˆã®åˆ¤å®šã«ä½¿ã†ã‚¯ãƒ©ã‚¹/å±æ€§ï¼ˆé †ã«å„ªå…ˆï¼‰
    selectedSlotQueries: [
      '[data-selected="1"]',
      '[aria-pressed="true"]',
      '.on', '.active', '.selected'
    ],

    // DOMã‹ã‚‰æ®‹ã‚ŠãŒå–ã‚Œãªã„å ´åˆã®ä¿é™ºï¼šslots APIã§æ®‹ã‚Šäººæ•°ã‚’å–å¾—
    useSlotsApiFallback: true
  };

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function toHHmm(s){
    if (!s) return '';
    const m = String(s).trim().match(/^(\d{1,2}):(\d{2})$/);
    return m ? `${('0'+(+m[1])).slice(-2)}:${m[2]}` : '';
  }

  function readSelectedDate(){
    const el = $(CFG.selDate);
    if (!el) return '';
    const m = (el.textContent||'').trim().match(/\b(20\d{2}-\d{2}-\d{2})\b/);
    return m ? m[1] : '';
  }

  function pickTimeFromButton(btn){
    if (!btn) return '';
    const dt = btn.getAttribute('data-time');
    if (dt) return toHHmm(dt);
    const t = (btn.textContent || '').match(/\b(\d{1,2}:\d{2})\b/);
    return t ? toHHmm(t[1]) : '';
  }

  function findSelectedSlotButton(){
    const wrap = $(CFG.slotsWrap);
    if (!wrap) return null;
    for (const q of CFG.selectedSlotQueries){
      const hit = wrap.querySelector(q);
      if (hit) return hit;
    }
    return null;
  }

  function parseRemainFromText(txt){
    if (!txt) return null;
    // ã€Œæ®‹ã‚Š3äººã€ã€Œæ®‹ã‚Š 3ã€ã€Œ3åã€ã€Œ(æ®‹ã‚Š:3)ã€ç­‰ã‚’ç·©ãã‚µãƒãƒ¼ãƒˆ
    const s = String(txt).replace(/\s/g,'');
    const m = s.match(/æ®‹ã‚Š?(\d+)äºº?|(\d+)\s*(äºº|å)/);
    const num = m ? (m[1] || m[2]) : null;
    const n = num ? parseInt(num, 10) : NaN;
    return isFinite(n) ? n : null;
  }

  function readRemainFromSlotDom(btn){
    if (!btn) return null;
    // data-remain å±æ€§ãŒã‚ã‚Œã°æœ€å„ªå…ˆ
    const dr = btn.getAttribute('data-remain');
    if (dr != null && dr !== '') {
      const n = parseInt(dr, 10);
      if (isFinite(n)) return n;
    }
    // ãƒœã‚¿ãƒ³è‡ªèº«ã‚„è¦ªã®ã‚µãƒ–è¦ç´ ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‹¾ã†
    const scope = btn.closest('.slot, .slot-item, .time, .row, button') || btn;
    for (const sel of CFG.remainSelectorsInsideSlot){
      const el = scope.querySelector(sel);
      if (el){
        const n = parseRemainFromText(el.textContent || el.innerText || '');
        if (n != null) return n;
      }
    }
    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã«ã€Œæ®‹ã‚Šâ—¯ã€ã‚’å«ã‚€å ´åˆã‚‚æ‹¾ã†
    const n2 = parseRemainFromText(btn.textContent || '');
    return n2 != null ? n2 : null;
  }

  function readPersonsTotal(){
    const val = sel => { const el = $(sel); if (!el) return 0; const n = parseInt(el.value,10); return isFinite(n) ? Math.max(0,n) : 0; };
    const a = val(CFG.adultSel), e = val(CFG.elemSel), k = val(CFG.kinderSel);
    const totalEl = $(CFG.totalSel);
    if (totalEl){
      const t = parseInt(totalEl.value,10);
      if (isFinite(t) && t > 0) return t;
    }
    return a + e + k;
  }

  function getApiBase(){ const u = new URL(location.href); return `${u.origin}${u.pathname}`; }

  async function fetchRemainFromApi(dateStr, timeStr){
    if (!CFG.useSlotsApiFallback || !dateStr || !timeStr) return null;
    try{
      const res = await fetch(`${getApiBase()}?api=slots&date=${encodeURIComponent(dateStr)}`, { headers:{'Accept':'application/json'} });
      if (!res.ok) return null;
      const j = await res.json();
      const slots = (j && j.slots) || [];
      const hit = slots.find(s => s.time === timeStr);
      return hit ? Number(hit.remain||0) : null;
    }catch(_){ return null; }
  }

  // ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¢å­˜ #infoModal å„ªå…ˆã€ç„¡ã‘ã‚Œã°è»½é‡ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ =====
  function showModal(message, title){
    const infoModal = document.getElementById('infoModal');
    if (infoModal){
      // æ—¢å­˜ infoModal ã®æ§‹é€ ã«åˆã‚ã›ã¦åŸ‹ã‚è¾¼ã‚€ï¼ˆæƒ³å®šï¼š.info-body ã¨é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚ã‚Šï¼‰
      const body = infoModal.querySelector('.info-body') || infoModal;
      (body).textContent = String(message||'');
      infoModal.style.display = 'flex';
      infoModal.setAttribute('aria-modal','true'); infoModal.setAttribute('role','dialog');
      // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°1å›ã ã‘ãƒ¯ã‚¤ãƒ¤
      const closeBtn = infoModal.querySelector('.modal-close, .btn-close, .btn');
      if (closeBtn && !closeBtn.__cmgBound){ closeBtn.addEventListener('click', ()=>{ infoModal.style.display='none'; }, {once:true}); closeBtn.__cmgBound = true; }
      return;
    }

    // ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«
    const root = document.createElement('div');
    root.className = 'cmg-backdrop';
    root.innerHTML = `
      <div class="cmg-card" role="dialog" aria-modal="true">
        <div class="cmg-hd"><div class="cmg-ttl">${esc(title || 'ãŠçŸ¥ã‚‰ã›')}</div></div>
        <div class="cmg-bd">${esc(message||'')}</div>
        <div class="cmg-ft"><button class="cmg-btn" id="cmgOk">OK</button></div>
      </div>`;
    const bye = ()=> root.remove();
    root.addEventListener('click', e=>{ if(e.target===root) bye(); });
    root.querySelector('#cmgOk').addEventListener('click', bye);
    document.addEventListener('keydown', function onKey(e){ if(e.key==='Escape'){ bye(); document.removeEventListener('keydown', onKey); }});
    document.body.appendChild(root);
  }
  function esc(s){ return String(s==null?'':s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

  // ===== æ ¸å¿ƒï¼šäººæ•°å…¥åŠ›ã®ãŸã³ã«ã€é¸æŠä¸­ã‚¹ãƒ­ãƒƒãƒˆã®æ®‹ã‚Šã¨å³æ™‚æ¯”è¼ƒ =====
  let last = { over:false, remain:null, total:null };

  async function runGuard(){
    const btn = findSelectedSlotButton();
    const timeStr = pickTimeFromButton(btn);
    const dateStr = readSelectedDate();
    const total   = readPersonsTotal();

    // å…¥åŠ›ãŒæƒã‚ãªã„/0åã®ã¨ãã¯è§£é™¤ã—ã¦çµ‚äº†
    if (!btn || !timeStr || !dateStr || total <= 0){
      setWarn(false);
      last = { over:false, remain:null, total:null };
      return true;
    }

    // DOM ã‹ã‚‰æ®‹ã‚Šäººæ•°ã‚’å„ªå…ˆã—ã¦å–å¾—
    let remain = readRemainFromSlotDom(btn);

    // å–ã‚Œãªã„å ´åˆã¯ API ã§è£œå®Œ
    if (remain == null){
      remain = await fetchRemainFromApi(dateStr, timeStr);
    }

    if (remain == null){
      // æ®‹ã‚ŠãŒåˆ†ã‹ã‚‰ãªã„å ´åˆã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼ˆã‚µãƒ¼ãƒå´ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãŒåƒãï¼‰
      setWarn(false);
      last = { over:false, remain:null, total };
      return true;
    }

    if (total > remain){
      // è¶…éï¼šå…¥åŠ›é€”ä¸­ã§ã‚‚å³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’1å›è¡¨ç¤ºï¼ˆåŒä¸€çŠ¶æ…‹ã§ã®é€£ç¶šè¡¨ç¤ºã¯æŠ‘åˆ¶ï¼‰
      if (!last.over || last.remain !== remain || last.total !== total){
        showModal('ç©ºãäººæ•°ã‚’è¶…ãˆã¦ã„ã‚‹ãŸã‚äºˆç´„ã§ãã¾ã›ã‚“', 'å®šå“¡ã‚ªãƒ¼ãƒãƒ¼');
      }
      setWarn(true);
      last = { over:true, remain, total };
      return false;
    }else{
      setWarn(false);
      last = { over:false, remain, total };
      return true;
    }
  }

  function setWarn(on){
    [CFG.adultSel, CFG.elemSel, CFG.kinderSel, CFG.totalSel].forEach(sel=>{
      $$(sel).forEach(el => on ? el.classList.add('cmg-warn') : el.classList.remove('cmg-warn'));
    });
    const btn = $(CFG.confirmBtn);
    if (btn){
      if (on){ btn.setAttribute('data-cmg-locked','1'); btn.disabled = true; }
      else   { btn.removeAttribute('data-cmg-locked'); btn.disabled = false; }
    }
  }

  function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this, arguments), ms); }; }

  function wire(){
    // äººæ•°å…¥åŠ›ã«ãƒ•ãƒƒã‚¯ï¼ˆé€”ä¸­ã§ã‚‚åˆ¤å®šï¼‰
    [CFG.adultSel, CFG.elemSel, CFG.kinderSel, CFG.totalSel].forEach(sel=>{
      $$(sel).forEach(el=>{
        if (!el || el.__cmgBound) return;
        el.addEventListener('input', debounce(runGuard, 100));
        el.addEventListener('change', debounce(runGuard, 50));
        el.__cmgBound = true;
      });
    });

    // ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚åˆ¤å®šï¼ˆåˆ¥æ™‚é–“ã‚’é¸ã‚“ã æ™‚ï¼‰
    const wrap = $(CFG.slotsWrap);
    if (wrap && !wrap.__cmgBound){
      wrap.addEventListener('click', debounce(runGuard, 80));
      wrap.__cmgBound = true;
    }

    // é€ä¿¡å‰ã®æœ€çµ‚ã‚¬ãƒ¼ãƒ‰
    const btn = $(CFG.confirmBtn);
    if (btn && !btn.__cmgSubmitBound){
      btn.addEventListener('click', async (ev)=>{
        const ok = await runGuard();
        if (!ok){ ev.preventDefault(); ev.stopPropagation(); }
      }, {passive:false});
      btn.__cmgSubmitBound = true;
    }
  }

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', ()=>{ wire(); runGuard(); });
  // SPAçš„ãªDOMå·®ã—æ›¿ãˆã«å‚™ãˆã¦è»½ãå†ã²ã‚‚ä»˜ã‘ï¼†å†åˆ¤å®š
  setInterval(()=>{ wire(); runGuard(); }, 1200);
})();
</script>








</body>
</html>
